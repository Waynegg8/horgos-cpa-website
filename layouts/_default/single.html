{{ define "main" }}
<main class="container single-wrapper" style="padding-top:80px;">
  <div class="single-content">
    <h1>{{ .Title }}</h1>
    {{/* 顯示文章元資訊：日期與分類 */}}
    <div class="post-meta">
      {{ with .Date }}<span class="date">{{ . | dateFormat "2006-01-02" }}</span>{{ end }}
      {{ with .Params.categories }}
      <span class="categories">
        {{ range . }}
          <a href="{{ (print "/categories/" (urlize .) "/") | relURL }}" class="tag">{{ . }}</a>
        {{ end }}
      </span>
      {{ end }}
    </div>
    {{ .Content }}
    {{/* 上一篇/下一篇導覽：僅在文章、常見問題、影音、下載頁顯示；若超出邊界則採用首尾輪循 */}}
    {{ if or (eq .Section "articles") (eq .Section "faq") (eq .Section "videos") (eq .Section "downloads") }}
    {{/* 決定上一頁與下一頁邏輯：優先採用同系列內的上一筆/下一筆；若不存在，則使用同 Section 其他系列的文章，並採輪循方式確保始終有連結 */}}
    {{ $sectionPages := where .Site.RegularPages "Section" .Section }}
    {{/* 取得目前頁面的系列名稱（若存在） */}}
    {{ $seriesName := "" }}
    {{ with .Params.series }}
      {{ $seriesName = index . 0 }}
    {{ end }}
    {{/* 使用 Scratch 儲存 prev 與 next 以便重新賦值 */}}
    {{ $.Scratch.Set "prev" .PrevInSection }}
    {{ $.Scratch.Set "next" .NextInSection }}
    {{ $prevPage := $.Scratch.Get "prev" }}
    {{ $nextPage := $.Scratch.Get "next" }}
    {{/* 若上一頁不存在或指向自身，則嘗試從其他系列取得最後一篇；若仍無，則取本 Section 最後一篇 */}}
    {{ if or (not $prevPage) (eq $prevPage.RelPermalink .RelPermalink) }}
      {{ if $seriesName }}
        {{ $otherSeries := where $sectionPages ".Params.series" "ne" $seriesName }}
        {{ if gt (len $otherSeries) 0 }}
          {{ $tmp := last 1 $otherSeries }}
          {{ $.Scratch.Set "prev" (index $tmp 0) }}
        {{ else }}
          {{ $tmp := last 1 $sectionPages }}
          {{ $.Scratch.Set "prev" (index $tmp 0) }}
        {{ end }}
      {{ else }}
        {{ $tmp := last 1 $sectionPages }}
        {{ $.Scratch.Set "prev" (index $tmp 0) }}
      {{ end }}
    {{ end }}
    {{/* 若下一頁不存在或指向自身，則嘗試從其他系列取得第一篇；若仍無，則取本 Section 第一篇 */}}
    {{ if or (not $nextPage) (eq $nextPage.RelPermalink .RelPermalink) }}
      {{ if $seriesName }}
        {{ $otherSeries := where $sectionPages ".Params.series" "ne" $seriesName }}
        {{ if gt (len $otherSeries) 0 }}
          {{ $.Scratch.Set "next" (index $otherSeries 0) }}
        {{ else }}
          {{ $.Scratch.Set "next" (index $sectionPages 0) }}
        {{ end }}
      {{ else }}
        {{ $.Scratch.Set "next" (index $sectionPages 0) }}
      {{ end }}
    {{ end }}
    {{ $prev := $.Scratch.Get "prev" }}
    {{ $next := $.Scratch.Get "next" }}
    <nav class="prev-next">
      {{ if and $prev (ne $prev.RelPermalink .RelPermalink) }}<a href="{{ $prev.RelPermalink }}" class="prev-article">上一篇：{{ $prev.Title }}</a>{{ end }}
      {{ if and $next (ne $next.RelPermalink .RelPermalink) }}<a href="{{ $next.RelPermalink }}" class="next-article">下一篇：{{ $next.Title }}</a>{{ end }}
    </nav>
    {{ end }}
    <!-- SEO 區塊 -->
    {{ partial "seo.html" . }}
  </div>
  <aside class="single-sidebar">
    <div class="sidebar-block">
      <h3>搜尋</h3>
      <input type="text" class="sidebar-search" placeholder="搜尋{{ .Title }}..." aria-label="搜尋...">
    </div>
    <div class="sidebar-block">
      <h3>分類</h3>
      <ul class="sidebar-list">
        {{ with .Params.categories }}
        {{ range . }}
        <li><a href="{{ (print "/categories/" (urlize .) "/") | relURL }}">{{ . }}</a></li>
        {{ end }}
        {{ end }}
      </ul>
    </div>
    <div class="sidebar-block">
      <h3>系列</h3>
      <ul class="sidebar-list">
        {{ with .Params.series }}
        {{ range . }}
        <li><a href="{{ (print "/series/" (urlize .) "/") | relURL }}">{{ . }}</a></li>
        {{ end }}
        {{ end }}
      </ul>
    </div>
    <div class="sidebar-block">
      <h3>關鍵字</h3>
      <ul class="sidebar-list">
        {{ with .Params.tags }}
        {{ range . }}
        <li><a href="{{ (print "/tags/" (urlize .) "/") | relURL }}">{{ . }}</a></li>
        {{ end }}
        {{ end }}
      </ul>
    </div>
    {{ if eq .Section "articles" }}
    <div class="sidebar-block">
      <h3>目錄</h3>
      <div class="table-of-contents">
        {{ .TableOfContents }}
      </div>
    </div>
    {{ end }}
  </aside>
</main>
{{ end }}