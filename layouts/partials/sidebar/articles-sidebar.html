<!-- 文章側邊欄 -->
<div class="sidebar">
    {{ if and (eq .Kind "page") (eq .Section "articles") }}
    <!-- 側邊搜尋（單一文章頁專用）：提交後導向列表頁並帶入關鍵字 -->
    <form class="sidebar-widget sidebar-search" action="/articles/" method="get" role="search" aria-label="文章搜尋">
        <input type="search" name="q" class="sidebar-search__input" placeholder="搜尋文章..." aria-label="搜尋文章" />
        <button type="submit" class="btn btn-primary btn-sm sidebar-search__btn" aria-label="搜尋">
            <i class="fas fa-search" aria-hidden="true"></i>
            <span class="sr-only">搜尋</span>
        </button>
    </form>
    {{ end }}
    {{/* 單一文章頁不再顯示「熱門標籤」，避免與主內容重複與視覺擁擠 */}}
    
    <!-- 系列文章：跟隨頁面自然滾動（不 sticky） -->
    <div class="sidebar-widget sidebar-series">
        <h3 class="sidebar-widget__title">系列文章</h3>
        <ul class="sidebar-series__list">
            {{ $currentSeries := .Params.series }}
            {{ if $currentSeries }}
              {{ $section := .Section }}
              {{ range where .Site.RegularPages "Section" $section }}
                {{ if and (eq .Params.series $currentSeries) (eq .Params.series_order 1) }}
                  <li class="sidebar-series__item"><a href="{{ .RelPermalink }}" class="sidebar-series__link">{{ $currentSeries }}</a></li>
                {{ end }}
              {{ end }}
            {{ else }}
              <li class="sidebar-series__item"><span class="sidebar-series__link">未分系列</span></li>
            {{ end }}
        </ul>
    </div>

    <!-- 目錄：應位於系列文章下、標籤雲上 -->
    {{ if and (eq .Kind "page") (eq .Section "articles") }}
    {{ partial "sidebar/table-of-contents.html" . }}
    {{ end }}
    
    {{ if ne .Kind "page" }}
    <!-- 最新文章：僅列表頁顯示，單一文章頁不顯示 -->
    <div class="sidebar-widget sidebar-recent">
        <h3 class="sidebar-widget__title">最新文章</h3>
        <ul class="sidebar-recent__list">
            {{ range first 5 (where .Site.RegularPages "Section" "articles") }}
            <li class="sidebar-recent__item">
                <a href="{{ .RelPermalink }}" class="sidebar-recent__link">
                    <div class="sidebar-recent__thumbnail">
                        {{ with .Params.image }}
                        <img src="{{ . }}" alt="{{ $.Title }}" loading="lazy">
                        {{ else }}
                        <img src="/uploads/images/general/general-default.jpg" alt="{{ $.Title }}" loading="lazy">
                        {{ end }}
                    </div>
                    <div class="sidebar-recent__content">
                        <div class="sidebar-recent__title">{{ .Title }}</div>
                        <div class="sidebar-recent__date">{{ .Date.Format "2006-01-02" }}</div>
                    </div>
                </a>
            </li>
            {{ end }}
        </ul>
    </div>
    {{ end }}
    
    <!-- 標籤雲：需要顯示；不顯示所謂「熱門標籤」 -->
    <div class="sidebar-widget sidebar-tags">
        <h3 class="sidebar-widget__title">標籤雲</h3>
        <div class="sidebar-tags__cloud">
            {{ range $name, $_ := .Site.Taxonomies.tags }}
                <a class="sidebar-tags__tag" href="{{ (printf "/tags/%s/" (urlize $name)) | relURL }}">{{ $name }}</a>
            {{ end }}
        </div>
    </div>
    
</div>