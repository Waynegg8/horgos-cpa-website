{{/*
  文章導航（不使用系列）：
  - 有分類：同分類按 order（缺省以日期補序）找相鄰；到邊界時改推其他分類的第一篇
  - 無分類：上一篇、下一篇皆從其他分類的第一篇中選，且兩側不可相同
  - 確保左右不會是同一篇；必要時以「該分類第二篇」或「全站最新非當前」作最後保底
*/}}

{{ $current := . }}
{{ $all := where .Site.RegularPages "Section" "articles" }}
{{ $all = where $all "Params.draft" "!=" true }}
{{ $scratch := newScratch }}

{{ $cat := .Params.category }}

{{/* 建立同分類清單（僅當有分類時）並依 order→日期 排序 */}}
{{ $sameCat := slice }}
{{ if ne $cat nil }}
  {{ $sameCat = where $all "Params.category" $cat }}
{{ end }}

{{ $withOrder := (where $sameCat "Params.order" "!=" nil) }}
{{ $withOrder = sort $withOrder "Params.order" "asc" }}
{{ $noOrder := (where $sameCat "Params.order" "==" nil) }}
{{ $noOrder = sort $noOrder ".Date" "asc" }}

{{ $scratch.Set "sortedCat" (slice) }}
{{ range $withOrder }}{{ $scratch.Add "sortedCat" (slice .) }}{{ end }}
{{ range $noOrder }}{{ $scratch.Add "sortedCat" (slice .) }}{{ end }}
{{ $sortedCat := ($scratch.Get "sortedCat") }}

{{/* 其他分類的第一篇清單（排序：各分類第一篇日期新→舊） */}}
{{ $scratch.Set "seenCats" (dict) }}
{{ $scratch.Set "otherFirst" (slice) }}
{{ range $all }}
  {{ $c := .Params.category }}
  {{ if ne $c nil }}
    {{ if or (eq $cat nil) (ne $c $cat) }}
      {{ if not (isset ($scratch.Get "seenCats") $c) }}
        {{ $catPages := where $all "Params.category" $c }}
        {{ $pHasOrder := where $catPages "Params.order" "!=" nil }}
        {{ $first := false }}
        {{ if gt (len $pHasOrder) 0 }}
          {{ $first = index (sort $pHasOrder "Params.order" "asc") 0 }}
        {{ else }}
          {{ $first = index (sort $catPages ".Date" "asc") 0 }}
        {{ end }}
        {{ if $first }}
          {{ $scratch.Add "otherFirst" (slice $first) }}
          {{ $scratch.SetInMap "seenCats" $c true }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}
{{ $otherFirst := sort ($scratch.Get "otherFirst") ".Date" "desc" }}

{{/* 初步候選：同分類相鄰（僅當有分類） */}}
{{ $prev := false }}
{{ $next := false }}
{{ if ne $cat nil }}
  {{ $idx := -1 }}
  {{ range $i, $p := $sortedCat }}{{ if eq $p.RelPermalink $current.RelPermalink }}{{ $idx = $i }}{{ end }}{{ end }}
  {{ if ge $idx 0 }}
    {{ if gt $idx 0 }}
      {{ $prev = index $sortedCat (sub $idx 1) }}
    {{ end }}
    {{ if lt (add $idx 1) (len $sortedCat) }}
      {{ $next = index $sortedCat (add $idx 1) }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* 邊界保底：使用其他分類第一篇，並保證兩側不同且不等於當前 */}}
{{ if not $prev }}
  {{ if gt (len $otherFirst) 0 }}
    {{ $prev = index $otherFirst 0 }}
    {{ if eq $prev.RelPermalink $current.RelPermalink }}{{ $prev = false }}{{ end }}
  {{ end }}
{{ end }}

{{ if not $next }}
  {{ if gt (len $otherFirst) 0 }}
    {{/* 找到與 prev 不同的第一個 */}}
    {{ range $i, $p := $otherFirst }}
      {{ if and (ne $p.RelPermalink $current.RelPermalink) (or (not $prev) (ne $p.RelPermalink $prev.RelPermalink)) }}
        {{ $next = $p }}
        {{ break }}
      {{ end }}
    {{ end }}
    {{ if not $next }}
      {{/* 若只有一個分類的第一篇，嘗試該分類的第二篇 */}}
      {{ if $prev }}
        {{ $pcat := $prev.Params.category }}
        {{ $plist := where $all "Params.category" $pcat }}
        {{ $pHasOrder := where $plist "Params.order" "!=" nil }}
        {{ if gt (len $pHasOrder) 1 }}
          {{ $sorted := sort $pHasOrder "Params.order" "asc" }}
          {{ $second := index $sorted 1 }}
          {{ if ne $second.RelPermalink $current.RelPermalink }}{{ $next = $second }}{{ end }}
        {{ else }}
          {{ $sorted := sort $plist ".Date" "desc" }}
          {{ range $sorted }}
            {{ if and (ne .RelPermalink $current.RelPermalink) (or (not $prev) (ne .RelPermalink $prev.RelPermalink)) }}
              {{ $next = . }}
              {{ break }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

<div class="article-navigation">
  <div class="article-navigation__links">
    {{ with $prev }}
      <div class="article-navigation__item">
        <a href="{{ .RelPermalink }}" class="btn btn-secondary article-navigation__prev" aria-label="上一篇：{{ .Title }}">
          <span>上一篇：{{ .Title }}</span>
        </a>
        {{ if ne .Params.category $cat }}
          <div class="article-navigation__caption">上一篇內容來自其他主題推薦。</div>
        {{ end }}
      </div>
    {{ end }}

    {{ with $next }}
      <div class="article-navigation__item">
        <a href="{{ .RelPermalink }}" class="btn btn-secondary article-navigation__next" aria-label="下一篇：{{ .Title }}">
          <span>下一篇：{{ .Title }}</span>
        </a>
        {{ if ne .Params.category $cat }}
          <div class="article-navigation__caption">下一篇內容來自其他主題推薦。</div>
        {{ end }}
      </div>
    {{ end }}
  </div>
</div>
{{ $current := . }}
{{ $all := where .Site.RegularPages "Section" "articles" }}
{{ $all = where $all "Params.draft" "!=" true }}
{{ $scratch := newScratch }}

{{ if .Params.series }}
<!-- 系列導航（智慧型） -->
{{ $series := .Params.series }}
{{ $category := .Params.category }}
{{ $seriesOrder := 1 }}
{{ with .Params.series_order }}{{ $seriesOrder = (int .) }}{{ end }}
{{ $seriesPosts := where $all "Params.series" $series }}
{{ $seriesCount := len $seriesPosts }}
{{ $firstList := where $seriesPosts "Params.series_order" 1 }}
{{ $scratch.Set "firstPost" false }}
{{ if gt (len $firstList) 0 }}{{ $scratch.Set "firstPost" (index $firstList 0) }}{{ end }}

<div class="series-navigation">

  {{/* 智慧型上一篇候選 */}}
  {{ $scratch.Set "prev" false }}
  {{ if gt $seriesOrder 1 }}
    {{ $prevList := where $seriesPosts "Params.series_order" (sub $seriesOrder 1) }}
    {{ if gt (len $prevList) 0 }}{{ $scratch.Set "prev" (index $prevList 0) }}{{ end }}
  {{ end }}
  {{ if not ($scratch.Get "prev") }}
    {{ $sameCatSeriesFirst := where (where (where $all "Params.series" "!=" nil) "Params.series" "!=" $series) "Params.category" $category }}
    {{ $sameCatSeriesFirst = where $sameCatSeriesFirst "Params.series_order" 1 }}
    {{ if gt (len $sameCatSeriesFirst) 0 }}
      {{ $scratch.Set "prev" (index (sort $sameCatSeriesFirst ".Date" "desc") 0) }}
    {{ else }}
      {{ $anyCatSeriesFirst := where (where $all "Params.series_order" 1) "Params.series" "!=" $series }}
      {{ if gt (len $anyCatSeriesFirst) 0 }}
        {{ $scratch.Set "prev" (index (sort $anyCatSeriesFirst ".Date" "desc") 0) }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* 智慧型下一篇候選 */}}
  {{ $scratch.Set "next" false }}
  {{ if lt $seriesOrder $seriesCount }}
    {{ $nextList := where $seriesPosts "Params.series_order" (add $seriesOrder 1) }}
    {{ if gt (len $nextList) 0 }}{{ $scratch.Set "next" (index $nextList 0) }}{{ end }}
  {{ end }}
  {{ if not ($scratch.Get "next") }}
    {{ $sameCatSeriesFirstN := where (where (where $all "Params.series" "!=" nil) "Params.series" "!=" $series) "Params.category" $category }}
    {{ $sameCatSeriesFirstN = where $sameCatSeriesFirstN "Params.series_order" 1 }}
    {{ if gt (len $sameCatSeriesFirstN) 0 }}
      {{ $scratch.Set "next" (index (sort $sameCatSeriesFirstN ".Date" "desc") 0) }}
    {{ else }}
      {{ $anyCatSeriesFirstN := where (where $all "Params.series_order" 1) "Params.series" "!=" $series }}
      {{ if gt (len $anyCatSeriesFirstN) 0 }}
        {{ $scratch.Set "next" (index (sort $anyCatSeriesFirstN ".Date" "desc") 0) }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* 如果備選結果導致上一篇與下一篇相同，嘗試改選不同的一篇避免重複 */}}
  {{ $prevSelTmp := ($scratch.Get "prev") }}
  {{ $nextSelTmp := ($scratch.Get "next") }}
  {{ if and $prevSelTmp $nextSelTmp }}
    {{ if eq $prevSelTmp.RelPermalink $nextSelTmp.RelPermalink }}
      {{ $sameList := where (where (where $all "Params.series" "!=" nil) "Params.series" "!=" $series) "Params.category" $category }}
      {{ $sameList = where $sameList "Params.series_order" 1 }}
      {{ if gt (len $sameList) 1 }}
        {{ $scratch.Set "next" (index (sort $sameList ".Date" "desc") 1) }}
      {{ else }}
        {{ $anyList := where (where $all "Params.series_order" 1) "Params.series" "!=" $series }}
        {{ $anyList = where $anyList "RelPermalink" "!=" $prevSelTmp.RelPermalink }}
        {{ if gt (len $anyList) 0 }}
          {{ $scratch.Set "next" (index (sort $anyList ".Date" "desc") 0) }}
        {{ else }}
          {{ $fallback := where (sort $all ".Date" "desc") "RelPermalink" "!=" $prevSelTmp.RelPermalink }}
          {{ if gt (len $fallback) 0 }}{{ $scratch.Set "next" (index $fallback 0) }}{{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  <div class="series-navigation__links">
    {{ $prevSel := ($scratch.Get "prev") }}
    {{ $nextSel := ($scratch.Get "next") }}
    {{ $isFirst := eq $seriesOrder 1 }}
    {{ $isLast := eq $seriesOrder $seriesCount }}

    {{ with $prevSel }}
      {{ $isSame := and .Params.series (eq .Params.series $series) }}
      {{ $seriesLabel := cond $isSame "本系列" (humanize .Params.series) }}
      {{ $order := (int (default 1 .Params.series_order)) }}
      <div class="series-navigation__item">
        <a href="{{ .RelPermalink }}" class="btn btn-secondary series-navigation__btn series-navigation__prev" aria-label="上一篇：{{ $seriesLabel }} 第 {{ $order }} 篇">
          <span>上一篇：{{ $seriesLabel }} 第 {{ $order }} 篇</span>
        </a>
        {{ if not $isSame }}
          <div class="series-navigation__caption">{{ if $isFirst }}本系列第一篇，上一篇內容來自其他系列推薦。{{ else }}上一篇內容來自其他系列推薦。{{ end }}</div>
        {{ end }}
      </div>
    {{ end }}

    {{ with $nextSel }}
      {{ $isSameN := and .Params.series (eq .Params.series $series) }}
      {{ $seriesLabelN := cond $isSameN "本系列" (humanize .Params.series) }}
      {{ $orderN := (int (default 1 .Params.series_order)) }}
      <div class="series-navigation__item">
        <a href="{{ .RelPermalink }}" class="btn btn-secondary series-navigation__btn series-navigation__next" aria-label="下一篇：{{ $seriesLabelN }} 第 {{ $orderN }} 篇">
          <span>下一篇：{{ $seriesLabelN }} 第 {{ $orderN }} 篇</span>
        </a>
        {{ if not $isSameN }}
          <div class="series-navigation__caption">{{ if $isLast }}本系列最後一篇，接下來將前往其他系列的推薦。{{ else }}下一篇內容來自其他系列推薦。{{ end }}</div>
        {{ end }}
      </div>
    {{ end }}
  </div>
</div>
{{ else }}
<!-- 非系列文章：遵循推薦邏輯 -->
{{ $cat := .Params.category }}
{{/* 1) 先在同分類中找日期相鄰 */}}
{{ $catPages := cond (ne $cat nil) (where $all "Params.category" $cat) (slice) }}
{{ $catPages = sort $catPages ".Date" "asc" }}
{{ $idx := -1 }}
{{ range $i, $p := $catPages }}
  {{ if eq $p.RelPermalink $current.RelPermalink }}{{ $idx = $i }}{{ end }}
{{ end }}
{{ $scratch.Set "prev" false }}
{{ $scratch.Set "next" false }}
{{ if ge $idx 0 }}
  {{ if gt $idx 0 }}{{ $scratch.Set "prev" (index $catPages (sub $idx 1)) }}{{ end }}
  {{ if lt (add $idx 1) (len $catPages) }}{{ $scratch.Set "next" (index $catPages (add $idx 1)) }}{{ end }}
{{ end }}

{{/* 2) 若同分類沒有前/後，採用文件精神的保底策略以避免空白：
      優先：同分類其他系列的 series_order=1；其次：其他分類系列的 series_order=1；最後：全站依日期回退 */}}
{{ if not ($scratch.Get "prev") }}
  {{ $sameCatSeriesFirst := (where (where (where $all "Params.series" "!=" nil) "Params.category" $cat) "Params.series_order" 1) }}
  {{ if gt (len $sameCatSeriesFirst) 0 }}
    {{ $scratch.Set "prev" (index (sort $sameCatSeriesFirst ".Date" "desc") 0) }}
  {{ else }}
    {{ $anySeriesFirst := where $all "Params.series_order" 1 }}
    {{ if gt (len $anySeriesFirst) 0 }}
      {{ $scratch.Set "prev" (index (sort $anySeriesFirst ".Date" "desc") 0) }}
    {{ else }}
      {{ $fallbackPrev := where (sort $all ".Date" "desc") "RelPermalink" "!=" $current.RelPermalink }}
      {{ if gt (len $fallbackPrev) 0 }}{{ $scratch.Set "prev" (index $fallbackPrev 0) }}{{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{ if not ($scratch.Get "next") }}
  {{ $sameCatSeriesFirstN := (where (where (where $all "Params.series" "!=" nil) "Params.category" $cat) "Params.series_order" 1) }}
  {{ if gt (len $sameCatSeriesFirstN) 0 }}
    {{ $scratch.Set "next" (index (sort $sameCatSeriesFirstN ".Date" "desc") 0) }}
  {{ else }}
    {{ $anySeriesFirstN := where $all "Params.series_order" 1 }}
    {{ if gt (len $anySeriesFirstN) 0 }}
      {{ $scratch.Set "next" (index (sort $anySeriesFirstN ".Date" "desc") 0) }}
    {{ else }}
      {{ $fallbackNext := where (sort $all ".Date" "asc") "RelPermalink" "!=" $current.RelPermalink }}
      {{ if gt (len $fallbackNext) 0 }}{{ $scratch.Set "next" (index $fallbackNext 0) }}{{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* 若推薦到系列文章則改指向其 series_order=1 */}}
{{ with ($scratch.Get "prev") }}
  {{ if .Params.series }}
    {{ if ne (int (default 1 .Params.series_order)) 1 }}
      {{ $first := where (where $all "Params.series" .Params.series) "Params.series_order" 1 }}
      {{ if gt (len $first) 0 }}{{ $scratch.Set "prev" (index $first 0) }}{{ end }}
    {{ end }}
  {{ end }}
{{ end }}
{{ with ($scratch.Get "next") }}
  {{ if .Params.series }}
    {{ if ne (int (default 1 .Params.series_order)) 1 }}
      {{ $firstN := where (where $all "Params.series" .Params.series) "Params.series_order" 1 }}
      {{ if gt (len $firstN) 0 }}{{ $scratch.Set "next" (index $firstN 0) }}{{ end }}
    {{ end }}
  {{ end }}
{{ end }}

<div class="article-navigation">
  <div class="article-navigation__links">
    {{ $prevSel := ($scratch.Get "prev") }}
    {{ $nextSel := ($scratch.Get "next") }}

    {{ with $prevSel }}
      <div class="article-navigation__item">
        <a href="{{ .RelPermalink }}" class="btn btn-secondary article-navigation__prev" aria-label="上一篇：{{ .Title }}">
          <span>上一篇：{{ .Title }}</span>
        </a>
        {{ if .Params.series }}
          <div class="article-navigation__caption">上一篇內容來自其他系列推薦。</div>
        {{ end }}
      </div>
    {{ end }}

    {{ with $nextSel }}
      <div class="article-navigation__item">
        <a href="{{ .RelPermalink }}" class="btn btn-secondary article-navigation__next" aria-label="下一篇：{{ .Title }}">
          <span>下一篇：{{ .Title }}</span>
        </a>
        {{ if .Params.series }}
          <div class="article-navigation__caption">下一篇內容來自其他系列推薦。</div>
        {{ end }}
      </div>
    {{ end }}
  </div>
</div>
{{ end }}