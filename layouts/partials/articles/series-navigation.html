{{ $current := . }}
{{ $all := where .Site.RegularPages "Section" "articles" }}
{{ $all = where $all "Params.draft" "!=" true }}

{{ if .Params.series }}
<!-- 系列導航（智慧型） -->
{{ $series := .Params.series }}
{{ $category := .Params.category }}
{{ $seriesOrder := 1 }}
{{ with .Params.series_order }}{{ $seriesOrder = (int .) }}{{ end }}
{{ $seriesPosts := where $all "Params.series" $series }}
{{ $seriesCount := len $seriesPosts }}
{{ $firstList := where $seriesPosts "Params.series_order" 1 }}
{{ $firstPost := cond (gt (len $firstList) 0) (index $firstList 0) nil }}

<div class="series-navigation">
  <div class="series-navigation__header">
    <h3 class="series-navigation__title">{{ $series }} 系列</h3>
    <span class="series-navigation__progress">{{ $series }} {{ $seriesOrder }}/{{ $seriesCount }}</span>
  </div>

  {{/* 智慧型上一篇候選 */}}
  {{ $prev := nil }}
  {{ if gt $seriesOrder 1 }}
    {{ $prevList := where $seriesPosts "Params.series_order" (sub $seriesOrder 1) }}
    {{ if gt (len $prevList) 0 }}{{ $prev = index $prevList 0 }}{{ end }}
  {{ end }}
  {{ if not $prev }}
    {{ $sameCatSeriesFirst := where (where (where $all "Params.series" "!=" nil) "Params.series" "!=" $series) "Params.category" $category }}
    {{ $sameCatSeriesFirst = where $sameCatSeriesFirst "Params.series_order" 1 }}
    {{ if gt (len $sameCatSeriesFirst) 0 }}
      {{ $prev = index ($sameCatSeriesFirst | sort "Date" "desc") 0 }}
    {{ else }}
      {{ $anyCatSeriesFirst := where (where $all "Params.series_order" 1) "Params.series" "!=" $series }}
      {{ if gt (len $anyCatSeriesFirst) 0 }}
        {{ $prev = index ($anyCatSeriesFirst | sort "Date" "desc") 0 }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* 智慧型下一篇候選 */}}
  {{ $next := nil }}
  {{ if lt $seriesOrder $seriesCount }}
    {{ $nextList := where $seriesPosts "Params.series_order" (add $seriesOrder 1) }}
    {{ if gt (len $nextList) 0 }}{{ $next = index $nextList 0 }}{{ end }}
  {{ end }}
  {{ if not $next }}
    {{ $sameCatSeriesFirstN := where (where (where $all "Params.series" "!=" nil) "Params.series" "!=" $series) "Params.category" $category }}
    {{ $sameCatSeriesFirstN = where $sameCatSeriesFirstN "Params.series_order" 1 }}
    {{ if gt (len $sameCatSeriesFirstN) 0 }}
      {{ $next = index ($sameCatSeriesFirstN | sort "Date" "desc") 0 }}
    {{ else }}
      {{ $anyCatSeriesFirstN := where (where $all "Params.series_order" 1) "Params.series" "!=" $series }}
      {{ if gt (len $anyCatSeriesFirstN) 0 }}
        {{ $next = index ($anyCatSeriesFirstN | sort "Date" "desc") 0 }}
      {{ end }}
    {{ end }}
  {{ end }}

  <div class="series-navigation__links">
    {{ if $prev }}
      <a href="{{ $prev.RelPermalink }}" class="btn btn-secondary series-navigation__btn series-navigation__prev" aria-label="上一篇：{{ $prev.Title }}">
        <i class="fas fa-arrow-left"></i>
        <span>上一篇：{{ $prev.Title }}</span>
      </a>
    {{ end }}
    {{ if $next }}
      <a href="{{ $next.RelPermalink }}" class="btn btn-secondary series-navigation__btn series-navigation__next" aria-label="下一篇：{{ $next.Title }}">
        <span>下一篇：{{ $next.Title }}</span>
        <i class="fas fa-arrow-right"></i>
      </a>
    {{ end }}
  </div>

  {{ if $firstPost }}
  <div class="series-navigation__all">
    <a href="{{ $firstPost.RelPermalink }}" class="btn btn-primary series-navigation__btn-all">
      <i class="fas fa-list"></i>
      查看完整系列
    </a>
  </div>
  {{ end }}
</div>
{{ else }}
<!-- 非系列文章：同分類日期相鄰（若為系列則指向該系列第1篇） -->
{{ $cat := .Params.category }}
{{ $catPages := where $all "Params.category" $cat }}
{{ $catPages = sort $catPages "Date" "asc" }}
{{ $idx := -1 }}
{{ range $i, $p := $catPages }}
  {{ if eq $p.RelPermalink $current.RelPermalink }}{{ $idx = $i }}{{ end }}
{{ end }}
{{ $prev := nil }}
{{ $next := nil }}
{{ if ge $idx 0 }}
  {{ if gt $idx 0 }}{{ $prev = index $catPages (sub $idx 1) }}{{ end }}
  {{ if lt (add $idx 1) (len $catPages) }}{{ $next = index $catPages (add $idx 1) }}{{ end }}
{{ end }}

{{/* 若推薦到系列文章則改指向其 series_order=1 */}}
{{ if and $prev $prev.Params.series }}
  {{ if ne (int (default 1 $prev.Params.series_order)) 1 }}
    {{ $first := where (where $all "Params.series" $prev.Params.series) "Params.series_order" 1 }}
    {{ if gt (len $first) 0 }}{{ $prev = index $first 0 }}{{ end }}
  {{ end }}
{{ end }}
{{ if and $next $next.Params.series }}
  {{ if ne (int (default 1 $next.Params.series_order)) 1 }}
    {{ $firstN := where (where $all "Params.series" $next.Params.series) "Params.series_order" 1 }}
    {{ if gt (len $firstN) 0 }}{{ $next = index $firstN 0 }}{{ end }}
  {{ end }}
{{ end }}

<div class="article-navigation">
  <div class="article-navigation__links">
    {{ if $prev }}
      <a href="{{ $prev.RelPermalink }}" class="btn btn-secondary article-navigation__prev" aria-label="上一篇：{{ $prev.Title }}">
        <i class="fas fa-arrow-left"></i>
        <span>上一篇：{{ $prev.Title }}</span>
      </a>
    {{ end }}
    {{ if $next }}
      <a href="{{ $next.RelPermalink }}" class="btn btn-secondary article-navigation__next" aria-label="下一篇：{{ $next.Title }}">
        <span>下一篇：{{ $next.Title }}</span>
        <i class="fas fa-arrow-right"></i>
      </a>
    {{ end }}
  </div>
</div>
{{ end }}