<!-- 營業狀態顯示模板 -->
<div class="business-status-container">
  <div class="business-status" id="business-status">
    <div class="status-indicator">
      <span class="status-dot" id="status-dot"></span>
      <span class="status-text" id="status-text">載入中...</span>
    </div>
    <div class="business-hours">
      <p>營業時間：週一至週五 08:30–12:30、13:30–17:30</p>
    </div>
    <div class="next-status" id="next-status"></div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 確保元素存在
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const nextStatus = document.getElementById('next-status');
    
    if (!statusDot || !statusText || !nextStatus) {
      console.error('營業狀態元素未找到');
      return;
    }
    
    // 初始化
    updateBusinessStatus();
    
    // 每分鐘更新一次
    setInterval(updateBusinessStatus, 60000);
    
    /**
     * 更新營業狀態
     */
    async function updateBusinessStatus() {
      try {
        // 獲取台北時間
        const now = new Date();
        const taipeiTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));
        
        // 格式化日期為YYYY-MM-DD
        const dateString = `${taipeiTime.getFullYear()}-${(taipeiTime.getMonth() + 1).toString().padStart(2, '0')}-${taipeiTime.getDate().toString().padStart(2, '0')}`;
        
        // 調用API
        const response = await fetch(`/api/business-status?date=${dateString}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        });
        
        if (!response.ok) {
          console.warn('API請求失敗，使用預設邏輯');
          updateStatusUIWithFallback(taipeiTime);
          return;
        }
        
        const data = await response.json();
        
        if (!data.success) {
          console.warn('API返回錯誤，使用預設邏輯');
          updateStatusUIWithFallback(taipeiTime);
          return;
        }
        
        // 更新UI
        updateStatusUI(data, taipeiTime);
      } catch (error) {
        console.error('更新營業狀態失敗:', error);
        // 發生錯誤時，使用預設邏輯
        updateStatusUIWithFallback(new Date());
      }
    }
    
    /**
     * 更新狀態UI（使用API數據）
     * @param {Object} data - API響應數據
     * @param {Date} taipeiTime - 台北時間
     */
    function updateStatusUI(data, taipeiTime) {
      // 清除所有狀態類別
      statusDot.classList.remove('open', 'closed', 'lunch');
      
      // 根據API狀態設置樣式
      switch (data.status) {
        case 'open':
          statusDot.classList.add('open');
          statusText.textContent = data.message;
          nextStatus.textContent = `下次關閉時間：${data.nextChangeTime}`;
          break;
        case 'lunch':
          statusDot.classList.add('lunch');
          statusText.textContent = data.message;
          nextStatus.textContent = `下次營業時間：${data.nextChangeTime}`;
          break;
        case 'closed':
        default:
          statusDot.classList.add('closed');
          statusText.textContent = data.message;
          nextStatus.textContent = `下次營業時間：${data.nextChangeTime}`;
          break;
      }
    }
    
    /**
     * 使用預設邏輯更新狀態UI
     * @param {Date} taipeiTime - 台北時間
     */
    function updateStatusUIWithFallback(taipeiTime) {
      // 清除所有狀態類別
      statusDot.classList.remove('open', 'closed', 'lunch');
      
      // 檢查是否為工作日（週一至週五）
      const day = taipeiTime.getDay();
      const isWeekday = day >= 1 && day <= 5;
      
      // 檢查是否在營業時間內
      const hour = taipeiTime.getHours();
      const minute = taipeiTime.getMinutes();
      const currentTime = hour * 60 + minute;
      
      // 早上營業時間：8:30-12:30 (510-750分鐘)
      const morningStart = 8 * 60 + 30;
      const morningEnd = 12 * 60 + 30;
      
      // 下午營業時間：13:30-17:30 (810-1050分鐘)
      const afternoonStart = 13 * 60 + 30;
      const afternoonEnd = 17 * 60 + 30;
      
      // 判斷是否營業中
      let isOpen = isWeekday && (
        (currentTime >= morningStart && currentTime < morningEnd) || 
        (currentTime >= afternoonStart && currentTime < afternoonEnd)
      );
      
      // 檢查是否為午休時間
      const isLunch = isWeekday && currentTime >= morningEnd && currentTime < afternoonStart;
      
      if (isOpen) {
        // 營業中
        statusDot.classList.add('open');
        statusText.textContent = '營業中';
        
        if (currentTime < morningEnd) {
          nextStatus.textContent = '12:30休息，13:30重新營業';
        } else {
          nextStatus.textContent = '17:30結束營業，明日8:30重新營業';
        }
      } else if (isLunch) {
        // 午休中
        statusDot.classList.add('lunch');
        statusText.textContent = '午休中';
        nextStatus.textContent = '13:30重新營業';
      } else {
        // 休息中
        statusDot.classList.add('closed');
        statusText.textContent = '休息中';
        
        if (day >= 1 && day <= 5) {
          if (currentTime < morningStart) {
            nextStatus.textContent = '今日8:30開始營業';
          } else {
            nextStatus.textContent = '明日8:30重新營業';
          }
        } else {
          nextStatus.textContent = '週一8:30重新營業';
        }
      }
    }
  });
</script>