{{ $current := . }}
{{ $all := where .Site.RegularPages "Section" "videos" }}
{{ $all = where $all "Params.draft" "!=" true }}

{{ $scratch := newScratch }}

{{/* 改為與文章相同的分類＋order邏輯（不使用系列） */}}
{{ $cat := .Params.category }}

{{ $sameCat := slice }}
{{ if ne $cat nil }}
  {{ $sameCat = where $all "Params.category" $cat }}
{{ end }}

{{ $withOrder := (where $sameCat "Params.order" "!=" nil) }}
{{ $withOrder = sort $withOrder "Params.order" "asc" }}
{{ $noOrder := (where $sameCat "Params.order" "==" nil) }}
{{ $noOrder = sort $noOrder ".Date" "asc" }}
{{ $scratch.Set "sortedCat" (slice) }}
{{ range $withOrder }}{{ $scratch.Add "sortedCat" (slice .) }}{{ end }}
{{ range $noOrder }}{{ $scratch.Add "sortedCat" (slice .) }}{{ end }}
{{ $sortedCat := ($scratch.Get "sortedCat") }}

{{/* 其他分類第一部清單 */}}
{{ $scratch.Set "seenCats" (dict) }}
{{ $scratch.Set "otherFirst" (slice) }}
{{ range $all }}
  {{ $c := .Params.category }}
  {{ if ne $c nil }}
    {{ if or (eq $cat nil) (ne $c $cat) }}
      {{ if not (isset ($scratch.Get "seenCats") $c) }}
        {{ $catPages := where $all "Params.category" $c }}
        {{ $pHasOrder := where $catPages "Params.order" "!=" nil }}
        {{ $first := cond (gt (len $pHasOrder) 0) (index (sort $pHasOrder "Params.order" "asc") 0) (index (sort $catPages ".Date" "asc") 0) }}
        {{ if $first }}
          {{ $scratch.Add "otherFirst" (slice $first) }}
          {{ $scratch.SetInMap "seenCats" $c true }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}
{{ $otherFirst := sort ($scratch.Get "otherFirst") ".Date" "desc" }}

{{ $prev := false }}
{{ $next := false }}
{{ if ne $cat nil }}
  {{ $idx := -1 }}
  {{ range $i, $p := $sortedCat }}{{ if eq $p.RelPermalink .RelPermalink }}{{ $idx = $i }}{{ end }}{{ end }}
  {{ if ge $idx 0 }}
    {{ if gt $idx 0 }}{{ $prev = index $sortedCat (sub $idx 1) }}{{ end }}
    {{ if lt (add $idx 1) (len $sortedCat) }}{{ $next = index $sortedCat (add $idx 1) }}{{ end }}
  {{ end }}
{{ end }}

{{ if not $prev }}
  {{ if gt (len $otherFirst) 0 }}
    {{ $prev = index $otherFirst 0 }}
  {{ end }}
{{ end }}

{{ if not $next }}
  {{ if gt (len $otherFirst) 0 }}
    {{ range $i, $p := $otherFirst }}
      {{ if or (not $prev) (ne $p.RelPermalink $prev.RelPermalink) }}
        {{ $next = $p }}
        {{ break }}
      {{ end }}
    {{ end }}
    {{ if not $next }}
      {{ if $prev }}
        {{ $pcat := $prev.Params.category }}
        {{ $plist := where $all "Params.category" $pcat }}
        {{ $pHasOrder := where $plist "Params.order" "!=" nil }}
        {{ if gt (len $pHasOrder) 1 }}
          {{ $sorted := sort $pHasOrder "Params.order" "asc" }}
          {{ $second := index $sorted 1 }}
          {{ if ne $second.RelPermalink .RelPermalink }}{{ $next = $second }}{{ end }}
        {{ else }}
          {{ $sorted := sort $plist ".Date" "desc" }}
          {{ range $sorted }}
            {{ if and (ne .RelPermalink $prev.RelPermalink) (ne .RelPermalink $.RelPermalink) }}
              {{ $next = . }}
              {{ break }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

<div class="series-navigation">
  <div class="series-navigation__links">
    {{ with $prev }}
      <div class="series-navigation__item">
        <a class="btn btn-secondary series-navigation__btn" href="{{ .RelPermalink }}">上一篇：{{ .Title }}</a>
        {{ if ne .Params.category $cat }}<div class="series-navigation__caption">上一篇內容來自其他主題推薦。</div>{{ end }}
      </div>
    {{ end }}
    {{ with $next }}
      <div class="series-navigation__item">
        <a class="btn btn-secondary series-navigation__btn" href="{{ .RelPermalink }}">下一篇：{{ .Title }}</a>
        {{ if ne .Params.category $cat }}<div class="series-navigation__caption">下一篇內容來自其他主題推薦。</div>{{ end }}
      </div>
    {{ end }}
  </div>
</div>

