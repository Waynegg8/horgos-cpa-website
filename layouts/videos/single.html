{{ define "main" }}
<div class="container">
  <!-- 影片頁面使用全寬佈局 -->
    <div class="full-width">
      <div class="full-width__content">
      <article class="post">
        <header class="post__header">
          <h1 class="post__title">{{ .Title }}</h1>
          {{ partial "videos/metadata.html" . }}
        </header>

        <div class="post__content">
          {{ partial "videos/player.html" . }}
          
          {{ $clean := .Content }}
          {{ with .Description }}
            {{ $clean = replace $clean (printf "<p>%s</p>" .) "" }}
            {{ $clean = replace $clean . "" }}
          {{ end }}
          {{/* 移除內容起始處與 Hero 重複的主標題（<h1>...） */}}
          {{ $clean = replaceRE "^\\s*<h1[^>]*>.*?</h1>" $clean "" }}
          <div class="video-description-content">
            {{ $clean | safeHTML }}
          </div>
          
          {{ partial "videos/series-navigation.html" . }}
          
          {{/* 單頁不再本地插入 CTA，統一於 base 模板 SEO 區塊上方輸出 */}}
          
          {{/* 或許你還想看看：推薦其他影片主題的第一部 */}}
          {{ $allVideos := where .Site.RegularPages "Section" "videos" }}
          {{ $currentCat := .Params.category }}
          {{ $scratch := newScratch }}
          {{ $scratch.Set "seen" (dict) }}
          {{ $scratch.Set "candidates" (slice) }}
          {{ range $allVideos }}
            {{ $c := .Params.category }}
            {{ if and (ne $c nil) (ne $c $currentCat) }}
              {{ if not (isset ($scratch.Get "seen") $c) }}
                {{ $catPages := where $allVideos "Params.category" $c }}
                {{ $withOrder := where $catPages "Params.order" "!=" nil }}
                {{ $first := cond (gt (len $withOrder) 0) (index (sort $withOrder "Params.order" "asc") 0) (index (sort $catPages ".Date" "asc") 0) }}
                {{ if and $first (ne $first.RelPermalink .RelPermalink) }}
                  {{ $scratch.Add "candidates" (slice $first) }}
                  {{ $scratch.SetInMap "seen" $c true }}
                {{ end }}
              {{ end }}
            {{ end }}
          {{ end }}
          {{/* 先取「其他主題的第一部」候選，若不足 3 再以其他主題的最新影片補滿 */}}
          {{ $initial := sort ($scratch.Get "candidates") ".Date" "desc" }}
          {{ $sel := newScratch }}
          {{ $sel.Set "list" (slice) }}
          {{ $sel.Set "links" (slice) }}
          {{ range $initial }}
            {{ $sel.Add "list" (slice .) }}
            {{ $sel.Add "links" (slice .RelPermalink) }}
          {{ end }}

          {{ if lt (len ($sel.Get "list")) 3 }}
            {{ $fallbackAll := sort $allVideos ".Date" "desc" }}
            {{ range $fallbackAll }}
              {{ $cat := .Params.category }}
              {{ if and (ne $cat $currentCat) (ne .RelPermalink $.RelPermalink) (not (in ($sel.Get "links") .RelPermalink)) }}
                {{ $sel.Add "list" (slice .) }}
                {{ $sel.Add "links" (slice .RelPermalink) }}
              {{ end }}
              {{ if ge (len ($sel.Get "list")) 3 }}{{ break }}{{ end }}
            {{ end }}
          {{ end }}

          {{ $related := first 3 ($sel.Get "list") }}
          {{ if gt (len $related) 0 }}
          <div class="related-videos">
            <h3>或許你還想看看</h3>
            <div class="related-videos-grid">
              {{ range $related }}
                {{ partial "videos/card.html" . }}
              {{ end }}
            </div>
          </div>
          {{ end }}
        </div>
      </article>
    </div>
  </div>
</div>
{{ end }}