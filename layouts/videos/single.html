{{ define "main" }}
<div class="container">
  <!-- 影片頁面使用兩欄佈局 -->
  <div class="two-column">
    <div class="two-column__main">
      <article class="post">
        <header class="post__header">
          <h1 class="post__title">{{ .Title }}</h1>
          {{ partial "videos/metadata.html" . }}
        </header>

        <div class="post__content">
          {{ partial "videos/player.html" . }}
          
          {{ $clean := .Content }}
          {{ with .Description }}
            {{ $clean = replace $clean (printf "<p>%s</p>" .) "" }}
            {{ $clean = replace $clean . "" }}
          {{ end }}
          <div class="video-description-content">
            {{ $clean | safeHTML }}
          </div>
          
          {{ partial "videos/series-navigation.html" . }}
          
          {{/* 單頁不再本地插入 CTA，統一於 base 模板 SEO 區塊上方輸出 */}}

          {{ partial "shared/comments.html" . }}
          
          {{/* 相關影片：優先以相同標籤；若無標籤則以相同分類；再無則以最新影片 */}}
          {{ $allVideos := where .Site.RegularPages "Section" "videos" }}
          {{ $related := slice }}
          {{ if .Params.tags }}
            {{ $related = where $allVideos "Params.tags" "intersect" .Params.tags }}
          {{ else if .Params.category }}
            {{ $related = where $allVideos "Params.category" .Params.category }}
          {{ else }}
            {{ $related = $allVideos.ByDate.Reverse }}
          {{ end }}
          {{ $related = where $related "Permalink" "!=" .Permalink }}
          {{ $related = first 3 $related }}
          {{ if gt (len $related) 0 }}
          <div class="related-videos">
            <h3>相關影片</h3>
            <div class="related-videos-grid">
              {{ range $related }}
                {{ partial "videos/card.html" . }}
              {{ end }}
            </div>
          </div>
          {{ end }}
        </div>
      </article>
    </div>
    
    <!-- 側邊欄 -->
    <div class="two-column__sidebar">
      {{ partial "sidebar/videos-sidebar.html" . }}
    </div>
  </div>
</div>
{{ end }}