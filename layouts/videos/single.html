{{ define "main" }}
<div class="container">
  <!-- 影片頁面使用全寬佈局 -->
    <div class="full-width">
      <div class="full-width__content">
      <article class="post">
        <header class="post__header">
          <h1 class="post__title">{{ .Title }}</h1>
          {{ partial "videos/metadata.html" . }}
        </header>

        <div class="post__content">
          {{ partial "videos/player.html" . }}
          
          {{ $clean := .Content }}
          {{ with .Description }}
            {{ $clean = replace $clean (printf "<p>%s</p>" .) "" }}
            {{ $clean = replace $clean . "" }}
          {{ end }}
          {{/* 移除內容起始處與 Hero 重複的主標題（<h1>...） */}}
          {{ $clean = replaceRE "^\\s*<h1[^>]*>.*?</h1>" $clean "" }}
          <div class="video-description-content">
            {{ $clean | safeHTML }}
          </div>
          
          {{ partial "videos/series-navigation.html" . }}
          
          {{/* 單頁不再本地插入 CTA，統一於 base 模板 SEO 區塊上方輸出 */}}
          
          {{/* 相關影片：嚴格同分類；同分類內優先同標籤，否則同分類最新；若無分類則不顯示 */}}
          {{ $allVideos := where .Site.RegularPages "Section" "videos" }}
          {{ $cat := .Params.category }}
          {{ $related := slice }}
          {{ if ne $cat nil }}
            {{ $sameCat := where $allVideos "Params.category" $cat }}
            {{ if .Params.tags }}
              {{ $tagged := where $sameCat "Params.tags" "intersect" .Params.tags }}
              {{ if gt (len $tagged) 0 }}
                {{ $related = $tagged }}
              {{ else }}
                {{ $related = $sameCat.ByDate.Reverse }}
              {{ end }}
            {{ else }}
              {{ $related = $sameCat.ByDate.Reverse }}
            {{ end }}
          {{ end }}
          {{ $related = where $related "Permalink" "!=" .Permalink }}
          {{ $related = first 3 $related }}
          {{ if gt (len $related) 0 }}
          <div class="related-videos">
            <h3>相關影片</h3>
            <div class="related-videos-grid">
              {{ range $related }}
                {{ partial "videos/card.html" . }}
              {{ end }}
            </div>
          </div>
          {{ end }}
        </div>
      </article>
    </div>
  </div>
</div>
{{ end }}